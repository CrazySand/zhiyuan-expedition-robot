# 中控回调接口文档

中控需提供本接口，用于接收 **PC 端 / 机器人端** 主动推送的事件。所有请求均由 **PC 端发起**（机器人状态由 PC 定时采集后推送，人脸/ASR 由机器人回调 PC 后由 PC 转发至中控），**中控不主动调用**，仅需实现该接口并对外暴露 URL 供 PC 配置即可。

---

## 1. 概述

| 项目 | 说明 |
|------|------|
| 调用方向 | **PC 端 → 中控**（机器人数据经 PC 汇总/转发后推送到中控） |
| 请求方法 | **POST** |
| Content-Type | `application/json` |
| 请求体 | `{ "action": "动作名", "params": { ... } }` |

PC 端通过配置项 `CLOUD_EVENT_CALLBACK_URL` 填写中控提供的完整 URL（示例：`http://192.168.10.100:8890/robot/api/event`）。

---

## 2. 请求体格式

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| action | string | 是 | 事件类型，见下表 |
| params | object | 是 | 该事件携带的数据，结构随 action 不同而不同 |

---

## 3. 事件类型（action）及 params 说明

### 3.1 statusReport（定时状态上报）

**说明**：PC 端定时任务（默认每 5 分钟）采集机器人系统状态、BMS、急停、告警列表后推送到中控。

| 字段 | 类型 | 说明 |
|------|------|------|
| current_state | string | 当前系统状态（如 Ready、Estop、Manual 等） |
| temperature | number | 当前温度，单位 0.1℃ |
| battery_percent | number | 当前电量百分比 |
| emergency_state | object | 急停相关信息 |
| emergency_state.active | boolean | 急停是否触发 |
| emergency_state.reason | string | 急停触发原因 |
| emergency_state.wireless_emergency_stop | boolean | 无线急停是否触发 |
| emergency_state.software_emergency_stop | boolean | 软件急停是否触发 |
| alert_list | array | 当前告警列表，每项含 id、alert_code、state、description、level、solution_list 等 |

**示例**

```json
{
  "action": "statusReport",
  "params": {
    "current_state": "Ready",
    "temperature": 289,
    "battery_percent": 29,
    "emergency_state": {
      "active": false,
      "reason": "",
      "wireless_emergency_stop": false,
      "software_emergency_stop": false
    },
    "alert_list": []
  }
}
```

---

### 3.2 faceRecognition（人脸识别结果）

**说明**：机器人端识别人脸后回调 PC，PC 将结果转发至中控。

| 字段 | 类型 | 说明 |
|------|------|------|
| timestamp | string | 时间戳 |
| face_id | string | 人脸 ID（可与云端人脸库 uid 对应） |
| confidence | number | 置信度 |

**示例**

```json
{
  "action": "faceRecognition",
  "params": {
    "timestamp": "1762933137153",
    "face_id": "AGI812541E1FB25869472CE",
    "confidence": 0.95
  }
}
```

---

### 3.3 asr（语音识别结果）

**说明**：机器人端上传音频至 PC，PC 完成语音识别后将文本转发至中控。

| 字段 | 类型 | 说明 |
|------|------|------|
| text | string | 识别出的文本 |

**示例**

```json
{
  "action": "asr",
  "params": {
    "text": "你好，请带我去接待区"
  }
}
```

---

### 3.4 ttsFinished（TTS 播报完成）

**说明**：中控或前端调用 PC 端发起 TTS 播报后，在播报结束后向中控推送本事件。

| 字段 | 类型 | 说明 |
|------|------|------|
| trace_id | string | 对应发起播报时返回的 trace_id |

**示例**

```json
{
  "action": "ttsFinished",
  "params": {
    "trace_id": "abc-123"
  }
}
```

---

### 3.5 navTaskPaused（导航任务暂停）

**说明**：中控下发导航任务后，PC 端轮询任务状态；当任务进入暂停状态时，向中控推送本事件。**同一任务仅推送一次**（即首次检测到 PAUSED 时推送，后续轮询到 PAUSED 不再重复推送）。

| 字段 | 类型 | 说明 |
|------|------|------|
| task_id | string | 导航任务 ID |
| state | string | 状态值，固定为 `PncServiceState_PAUSED` |

**示例**

```json
{
  "action": "navTaskPaused",
  "params": {
    "task_id": "nav-001",
    "state": "PncServiceState_PAUSED"
  }
}
```

---

### 3.6 navTaskFinished（导航任务结束）

**说明**：导航任务进入终止状态（成功、失败或其它非运行/暂停状态）时，PC 端向中控推送本事件并结束对该任务的轮询。

| 字段 | 类型 | 说明 |
|------|------|------|
| task_id | string | 导航任务 ID |
| state | string | 终止状态，如 `PncServiceState_SUCCESS`、`PncServiceState_FAILED` 等 |

**示例**

```json
{
  "action": "navTaskFinished",
  "params": {
    "task_id": "nav-001",
    "state": "PncServiceState_SUCCESS"
  }
}
```

---

## 4. 中控实现建议

- 接口需支持 **POST**、**application/json**，并从 body 中解析 `action`、`params`。
- 按 `action` 分发到不同业务逻辑（状态上报入库/告警、人脸结果关联用户、ASR 文本触发指令等）。
- 建议返回 HTTP 2xx 表示接收成功，便于 PC 端或后续扩展做重试策略。
- 本接口为 **被推送端**，中控无需主动请求 PC 或机器人；仅需保证 URL 可被 PC 访问（网络可达、防火墙放行等）。

---

## 5. 与 PC 端接口的关系

| 方向 | 说明 |
|------|------|
| 中控 → PC | 中控调用《PC 端 API 接口文档》中的接口（TTS、地图、导航、人脸、ASR 等），主动请求 PC。 |
| PC → 中控 | PC 通过本回调接口向中控推送状态、人脸结果、ASR 结果等，即本文档描述的内容。 |
| 机器人 → PC | 机器人通过 PC 的 Webhooks（如 `/api/webhooks/face-recognition`、`/api/webhooks/asr/audio`）回调 PC，**中控不直接与机器人通信**。 |
